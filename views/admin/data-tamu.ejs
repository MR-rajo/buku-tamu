<!DOCTYPE html>
<html lang="id">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title><%= title %></title>

    <script src="https://cdn.tailwindcss.com"></script>

    <script>
      tailwind.config = {
        theme: {
          extend: {
            colors: {
              primary: "#6184D6",
              "primary-dark": "#4B6BB5",
            },
          },
        },
      };
    </script>

    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css"
    />

    <!-- SweetAlert2 -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <style>
      @import url("https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap");

      body {
        font-family: "Inter", sans-serif;
      }

      .animate-fade-in {
        animation: fadeIn 0.5s ease-in;
      }

      @keyframes fadeIn {
        from {
          opacity: 0;
          transform: translateY(20px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      /* Modal Styles */
      .modal {
        display: none;
        position: fixed;
        z-index: 1000;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        overflow: auto;
        background-color: rgba(0, 0, 0, 0.9);
        animation: fadeIn 0.3s ease-in;
      }

      .modal-content {
        margin: auto;
        display: block;
        max-width: 90%;
        max-height: 90%;
        animation: zoomIn 0.3s ease-in;
      }

      @keyframes zoomIn {
        from {
          transform: scale(0.5);
        }
        to {
          transform: scale(1);
        }
      }

      .close-modal {
        position: absolute;
        top: 20px;
        right: 35px;
        color: #f1f1f1;
        font-size: 40px;
        font-weight: bold;
        cursor: pointer;
        transition: 0.3s;
      }

      .close-modal:hover,
      .close-modal:focus {
        color: #bbb;
      }

      /* Progress Bar Styles */
      .progress-overlay {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.7);
        z-index: 9999;
        justify-content: center;
        align-items: center;
        animation: fadeIn 0.3s ease-in;
      }

      .progress-container {
        background: white;
        border-radius: 20px;
        padding: 40px;
        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        max-width: 500px;
        width: 90%;
        text-align: center;
        animation: slideUp 0.4s ease-out;
      }

      @keyframes slideUp {
        from {
          transform: translateY(50px);
          opacity: 0;
        }
        to {
          transform: translateY(0);
          opacity: 1;
        }
      }

      .progress-icon {
        font-size: 64px;
        color: #22c55e;
        margin-bottom: 20px;
        animation: bounce 1s infinite;
      }

      @keyframes bounce {
        0%,
        100% {
          transform: translateY(0);
        }
        50% {
          transform: translateY(-10px);
        }
      }

      .progress-title {
        font-size: 24px;
        font-weight: 700;
        color: #1f2937;
        margin-bottom: 10px;
      }

      .progress-subtitle {
        font-size: 14px;
        color: #6b7280;
        margin-bottom: 30px;
      }

      .progress-bar-container {
        width: 100%;
        height: 8px;
        background: #e5e7eb;
        border-radius: 999px;
        overflow: hidden;
        margin-bottom: 15px;
        position: relative;
      }

      .progress-bar {
        height: 100%;
        background: linear-gradient(90deg, #22c55e, #16a34a);
        border-radius: 999px;
        width: 0%;
        transition: width 0.3s ease;
        position: relative;
        overflow: hidden;
      }

      .progress-bar::after {
        content: "";
        position: absolute;
        top: 0;
        left: 0;
        bottom: 0;
        right: 0;
        background: linear-gradient(
          90deg,
          transparent,
          rgba(255, 255, 255, 0.3),
          transparent
        );
        animation: shimmer 1.5s infinite;
      }

      @keyframes shimmer {
        0% {
          transform: translateX(-100%);
        }
        100% {
          transform: translateX(100%);
        }
      }

      .progress-percentage {
        font-size: 18px;
        font-weight: 600;
        color: #22c55e;
        margin-top: 10px;
      }

      .progress-status {
        font-size: 13px;
        color: #9ca3af;
        margin-top: 5px;
        font-style: italic;
      }

      .checkmark-circle {
        display: none;
        width: 80px;
        height: 80px;
        margin: 0 auto 20px;
        border-radius: 50%;
        background: #22c55e;
        position: relative;
        animation: scaleIn 0.5s ease-out;
      }

      @keyframes scaleIn {
        from {
          transform: scale(0);
        }
        to {
          transform: scale(1);
        }
      }

      .checkmark {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        width: 40px;
        height: 40px;
      }

      .checkmark-path {
        stroke: white;
        stroke-width: 4;
        stroke-linecap: round;
        stroke-dasharray: 60;
        stroke-dashoffset: 60;
        animation: drawCheck 0.5s ease-out 0.2s forwards;
      }

      @keyframes drawCheck {
        to {
          stroke-dashoffset: 0;
        }
      }

      /* Statistik Collapse Animation */
      #statistikContent {
        transition: max-height 0.5s cubic-bezier(0.4, 0, 0.2, 1);
      }

      #toggleIcon {
        transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      }

      /* Responsive adjustments */
      @media (max-width: 768px) {
        .ml-64 {
          margin-left: 0;
        }
      }

      /* Generate Kode Modal */
      .generate-modal {
        display: none;
        position: fixed;
        z-index: 2000;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        overflow: auto;
        background-color: rgba(0, 0, 0, 0.6);
        animation: fadeIn 0.3s ease-in;
      }

      .generate-modal.active {
        display: flex;
        align-items: center;
        justify-content: center;
      }

      .generate-modal-content {
        background: white;
        border-radius: 16px;
        max-width: 700px;
        width: 90%;
        max-height: 80vh;
        overflow: hidden;
        display: flex;
        flex-direction: column;
        animation: slideUp 0.3s ease-out;
      }

      .generate-modal-body {
        overflow-y: auto;
        max-height: 50vh;
      }

      /* Checkbox Custom */
      .custom-checkbox {
        appearance: none;
        width: 20px;
        height: 20px;
        border: 2px solid #d1d5db;
        border-radius: 4px;
        cursor: pointer;
        position: relative;
        transition: all 0.2s;
      }

      .custom-checkbox:checked {
        background: #6184d6;
        border-color: #6184d6;
      }

      .custom-checkbox:checked::after {
        content: "✓";
        position: absolute;
        color: white;
        font-size: 14px;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
      }

      /* SweetAlert2 Custom Styling */
      .swal2-container {
        z-index: 10000 !important;
      }
      
      .swal2-popup {
        border-radius: 16px !important;
        font-family: "Inter", sans-serif !important;
        z-index: 10001 !important;
      }

      .swal2-title {
        font-size: 24px !important;
        font-weight: 700 !important;
        color: #1f2937 !important;
      }

      .swal2-html-container {
        font-size: 16px !important;
        color: #4b5563 !important;
      }

      .swal2-confirm,
      .swal2-cancel {
        border-radius: 8px !important;
        font-weight: 600 !important;
        padding: 12px 24px !important;
        transition: all 0.3s ease !important;
      }

      .swal2-confirm:hover {
        transform: scale(1.05) !important;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15) !important;
      }

      .swal2-cancel:hover {
        transform: scale(1.05) !important;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15) !important;
      }

      .swal2-icon {
        border-width: 3px !important;
      }

      /* Shortcut Dropdown Styles */
      .shortcut-dropdown {
        position: relative;
      }

      .shortcut-dropdown-menu {
        position: absolute;
        right: 0;
        top: 100%;
        margin-top: 8px;
        min-width: 280px;
        background: white;
        border-radius: 12px;
        box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
        border: 1px solid #e5e7eb;
        z-index: 50;
        transform-origin: top right;
        transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
      }

      .shortcut-dropdown-menu.hidden {
        opacity: 0;
        visibility: hidden;
        transform: scale(0.95) translateY(-10px);
      }

      .shortcut-dropdown-menu.visible {
        opacity: 1;
        visibility: visible;
        transform: scale(1) translateY(0);
      }

      .dropdown-item {
        display: flex;
        align-items: center;
        width: 100%;
        padding: 12px 16px;
        text-align: left;
        border: none;
        background: none;
        cursor: pointer;
        transition: background-color 0.2s ease;
      }

      .dropdown-item:hover {
        background-color: #f9fafb;
      }

      .dropdown-item:first-child {
        border-top-left-radius: 12px;
        border-top-right-radius: 12px;
      }

      .dropdown-item:last-child {
        border-bottom-left-radius: 12px;
        border-bottom-right-radius: 12px;
      }

      .dropdown-icon {
        width: 40px;
        height: 40px;
        border-radius: 8px;
        display: flex;
        align-items: center;
        justify-content: center;
        margin-right: 12px;
        transition: all 0.2s ease;
      }

      .rotate-180 {
        transform: rotate(180deg);
      }
    </style>
  </head>
  <body class="bg-gray-50">
    <!-- Sidebar -->
    <%- include('../partials/admin-sidebar') %>

    <!-- Main Content -->
    <div class="ml-64 p-4">
      <!-- Header with Admin Info -->
      <div class="mb-6 flex items-start justify-between">
        <div>
          <h1 class="text-3xl font-bold text-gray-800 mb-2">
            <i class="fas fa-users text-primary mr-3"></i>Data Tamu
          </h1>
          <p class="text-gray-600">Kelola data tamu yang sudah terdaftar</p>
        </div>
        
        <!-- Admin Info (Top Right) -->
        <div class="px-6 py-4 flex items-center gap-3">
          <div class="w-12 h-12 bg-gradient-to-br from-primary to-blue-500 rounded-full flex items-center justify-center text-white font-bold text-lg">
            <i class="fas fa-user-shield"></i>
          </div>
          <div>
            <p class="font-semibold text-gray-800"><%= session.user.name %></p>
            <p class="text-xs text-gray-500">
              <i class="fas fa-shield-alt text-primary mr-1"></i>Administrator
            </p>
          </div>
        </div>
      </div>

      <!-- Success/Error Messages -->
      <% if (success) { %>
      <div
        class="bg-green-50 border-l-4 border-green-500 p-4 mb-6 animate-fade-in"
      >
        <div class="flex items-center">
          <i class="fas fa-check-circle text-green-500 mr-3"></i>
          <p class="text-sm text-green-700"><%= success %></p>
        </div>
      </div>
      <% } %> <% if (error) { %>
      <div class="bg-red-50 border-l-4 border-red-500 p-4 mb-6 animate-fade-in">
        <div class="flex items-center">
          <i class="fas fa-exclamation-circle text-red-500 mr-3"></i>
          <p class="text-sm text-red-700"><%= error %></p>
        </div>
      </div>
      <% } %>

      <!-- Filter & Statistics -->
      <div class="mb-6">
        <!-- Statistics Cards -->
        <div class="w-full">
          <div class="bg-white rounded-xl shadow-lg p-6">
            <h3 class="text-lg font-semibold text-gray-800 mb-4 flex items-center">
              <i class="fas fa-chart-bar text-primary mr-2"></i>
              Statistik Tamu
            </h3>
            <div class="grid grid-cols-1 sm:grid-cols-3 gap-4">
              <!-- Total Tamu -->
              <div class="bg-gradient-to-br from-blue-500 to-blue-600 rounded-lg p-4 text-white">
                <div class="flex items-center justify-between">
                  <div>
                    <p class="text-sm opacity-90">Total Tamu</p>
                    <p class="text-3xl font-bold mt-1"><%= guests.length %></p>
                  </div>
                  <div class="text-4xl opacity-80">
                    <i class="fas fa-users"></i>
                  </div>
                </div>
              </div>

              <!-- Tamu Hari Ini -->
              <div class="bg-gradient-to-br from-green-500 to-green-600 rounded-lg p-4 text-white">
                <div class="flex items-center justify-between">
                  <div>
                    <p class="text-sm opacity-90">Hari Ini</p>
                    <p class="text-3xl font-bold mt-1">
                      <%= guests.filter(g => new Date(g.created_at).toDateString() === new Date().toDateString()).length %>
                    </p>
                  </div>
                  <div class="text-4xl opacity-80">
                    <i class="fas fa-calendar-day"></i>
                  </div>
                </div>
              </div>

              <!-- Jumlah Sekolah -->
              <div class="bg-gradient-to-br from-purple-500 to-purple-600 rounded-lg p-4 text-white">
                <div class="flex items-center justify-between">
                  <div>
                    <p class="text-sm opacity-90">Total Sekolah</p>
                    <p class="text-3xl font-bold mt-1"><%= schools.length %></p>
                  </div>
                  <div class="text-4xl opacity-80">
                    <i class="fas fa-school"></i>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Statistik Per Sekolah -->
      <div class="bg-white rounded-xl shadow-lg overflow-hidden mb-6">
        <!-- Header dengan Toggle Button -->
        <div 
          class="flex items-center justify-between p-5 bg-gradient-to-r from-primary to-blue-600 cursor-pointer hover:from-primary-dark hover:to-blue-700 transition-all"
          onclick="toggleStatistik()"
        >
          <div class="flex items-center gap-3">
            <div class="w-10 h-10 bg-white bg-opacity-20 rounded-lg flex items-center justify-center">
              <i class="fas fa-chart-pie text-white text-lg"></i>
            </div>
            <div>
              <h3 class="text-lg font-semibold text-white">Statistik Per Instansi</h3>
              <p class="text-sm text-blue-100">Klik untuk melihat detail</p>
            </div>
          </div>
          <div id="toggleIcon" class="text-white text-xl transition-transform duration-300">
            <i class="fas fa-chevron-down"></i>
          </div>
        </div>

        <!-- Content yang bisa di-collapse -->
        <div id="statistikContent" class="max-h-0 overflow-hidden transition-all duration-500 ease-in-out">
          <div class="p-5">
            <% if (schoolStats.length > 0) { %>
              <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                <% 
                const maxTamu = Math.max(...schoolStats.map(s => s.total_tamu));
                schoolStats.forEach((stat, index) => { 
                  const percentage = maxTamu > 0 ? (stat.total_tamu / maxTamu * 100) : 0;
                %>
                <!-- Card Individual Per Sekolah -->
                <div class="bg-white rounded-xl shadow-md hover:shadow-xl transition-all duration-300 overflow-hidden">
                  <!-- Header Card -->
                  <div class="bg-gradient-to-r from-primary to-blue-500 p-4">
                    <div class="flex items-center gap-3">
                      <div class="w-12 h-12 bg-white bg-opacity-25 rounded-lg flex items-center justify-center text-white font-bold text-xl flex-shrink-0">
                        <%= stat.nama_sekolah.charAt(0).toUpperCase() %>
                      </div>
                      <div class="flex-1 min-w-0">
                        <p class="font-semibold text-white truncate"><%= stat.nama_sekolah %></p>
                        <div class="flex gap-2 mt-2">
                          <span class="inline-flex items-center gap-1 bg-white bg-opacity-20 text-white px-2.5 py-1 rounded-full text-xs font-medium">
                            <i class="fas fa-users"></i>
                            <%= stat.total_tamu %>
                          </span>
                          <% if (stat.tamu_hari_ini > 0) { %>
                          <span class="inline-flex items-center gap-1 bg-green-400 bg-opacity-90 text-white px-2.5 py-1 rounded-full text-xs font-medium">
                            <i class="fas fa-arrow-up"></i>
                            +<%= stat.tamu_hari_ini %>
                          </span>
                          <% } %>
                        </div>
                      </div>
                    </div>
                  </div>

                  <!-- Body Card - Selalu Terlihat -->
                  <div class="p-4 bg-gray-50">
                    <!-- Progress Bar -->
                    <div class="mb-4">
                      <div class="flex items-center justify-between mb-2">
                        <span class="text-xs font-medium text-gray-600">Progress Kunjungan</span>
                        <span class="text-xs font-bold text-primary"><%= percentage.toFixed(0) %>%</span>
                      </div>
                      <div class="w-full bg-gray-200 rounded-full h-2.5 overflow-hidden">
                        <div 
                          class="bg-gradient-to-r from-primary via-blue-500 to-blue-600 h-full rounded-full transition-all duration-700"
                          style="width: <%= percentage.toFixed(0) %>%"
                        ></div>
                      </div>
                    </div>

                    <!-- Detail Info -->
                    <div class="space-y-2.5">
                      <div class="flex items-center justify-between py-2 border-b border-gray-200">
                        <span class="text-xs text-gray-600 flex items-center">
                          <i class="fas fa-users text-blue-500 mr-2 w-4"></i>
                          Total Tamu
                        </span>
                        <span class="text-sm font-bold text-gray-800"><%= stat.total_tamu %></span>
                      </div>

                      <div class="flex items-center justify-between py-2 border-b border-gray-200">
                        <span class="text-xs text-gray-600 flex items-center">
                          <i class="fas fa-calendar-day text-green-500 mr-2 w-4"></i>
                          Hari Ini
                        </span>
                        <% if (stat.tamu_hari_ini > 0) { %>
                          <span class="text-sm font-bold text-green-600">+<%= stat.tamu_hari_ini %></span>
                        <% } else { %>
                          <span class="text-sm text-gray-400">0</span>
                        <% } %>
                      </div>

                      <div class="flex items-start justify-between py-2">
                        <span class="text-xs text-gray-600 flex items-center">
                          <i class="far fa-clock text-purple-500 mr-2 w-4"></i>
                          Kunjungan Terakhir
                        </span>
                        <span class="text-xs text-gray-700 text-right">
                          <% if (stat.kunjungan_terakhir) { %>
                            <%= new Date(stat.kunjungan_terakhir).toLocaleString('id-ID', { 
                              day: 'numeric', 
                              month: 'short',
                              hour: '2-digit',
                              minute: '2-digit'
                            }) %>
                          <% } else { %>
                            <span class="text-gray-400">Belum ada</span>
                          <% } %>
                        </span>
                      </div>
                    </div>
                  </div>
                </div>
                <% }); %>
              </div>
            <% } else { %>
              <div class="py-12 text-center">
                <div class="inline-flex items-center justify-center w-16 h-16 bg-gray-100 rounded-full mb-3">
                  <i class="fas fa-inbox text-gray-400 text-2xl"></i>
                </div>
                <p class="text-gray-500 font-medium">Belum ada data statistik</p>
                <p class="text-sm text-gray-400 mt-1">Data akan muncul setelah ada tamu yang terdaftar</p>
              </div>
            <% } %>
          </div>
        </div>
      </div>

      <!-- Filter & Actions Section -->
      <div class="mb-6 flex flex-col lg:flex-row gap-6 justify-between">
        <!-- Filter Sekolah -->
        <div class="flex-1 max-w-2xl">
          <div class="bg-white rounded-xl shadow-lg p-6">
            <h3 class="text-lg font-semibold text-gray-800 mb-4 flex items-center">
              <i class="fas fa-filter text-primary mr-2"></i>
              Filter Instansi
            </h3>
            <select
              id="schoolFilter"
              onchange="filterBySchool(this.value)"
              class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent transition"
            >
              <option value="all" <%= selectedSchool === 'all' ? 'selected' : '' %>>
                Semua Instansi
              </option>
              <% schools.forEach(school => { %>
              <option value="<%= school.id %>" <%= selectedSchool == school.id ? 'selected' : '' %>>
                <%= school.nama_sekolah %>
              </option>
              <% }); %>
            </select>
          </div>
        </div>

        <!-- ShortCut Actions Dropdown -->
        <div class="lg:flex-shrink-0">
          <div class="rounded-xl shadow-lg p-6">
            <div class="relative">
              <button
                id="shortcutDropdownBtn"
                onclick="toggleShortcutDropdown()"
                class="bg-gradient-to-r from-primary to-blue-600 hover:from-primary-dark hover:to-blue-700 text-white px-6 py-3 rounded-lg shadow-lg transition transform cursor-pointer flex items-center gap-3 min-w-[160px] justify-between"
              >
                <div class="flex items-center gap-3">
                  <i class="fas fa-bolt text-lg"></i>
                  <span class="font-semibold">ShortCut</span>
                </div>
                <i id="shortcutDropdownIcon" class="fas fa-chevron-down transition-transform duration-200"></i>
              </button>

              <!-- Dropdown Menu -->
              <div
                id="shortcutDropdownMenu"
                class="absolute right-0 mt-2 w-64 bg-white rounded-lg shadow-xl border border-gray-100 opacity-0 invisible transform scale-95 transition-all duration-200 z-50"
              >
                <div class="py-2">
                  <!-- Copy Link Public -->
                  <button
                    onclick="handleCopyPublicLink(); closeShortcutDropdown();"
                    class="w-full text-left px-4 py-3 hover:bg-gray-50 transition flex items-center gap-3 group"
                  >
                    <div class="w-10 h-10 bg-orange-100 group-hover:bg-orange-200 rounded-lg flex items-center justify-center transition">
                      <i class="fas fa-link text-orange-600"></i>
                    </div>
                    <div>
                      <p class="font-medium text-gray-800">Copy Link Public</p>
                      <p class="text-xs text-gray-500">Copy link form buku tamu untuk dibagikan</p>
                    </div>
                  </button>

                  <!-- Export Excel -->
                  <button
                    onclick="handleExportExcel(); closeShortcutDropdown();"
                    class="w-full text-left px-4 py-3 hover:bg-gray-50 transition flex items-center gap-3 group"
                  >
                    <div class="w-10 h-10 bg-green-100 group-hover:bg-green-200 rounded-lg flex items-center justify-center transition">
                      <i class="fas fa-file-excel text-green-600"></i>
                    </div>
                    <div>
                      <p class="font-medium text-gray-800">Export ke Excel</p>
                      <p class="text-xs text-gray-500">Download data tamu dalam format Excel</p>
                    </div>
                  </button>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Table -->
      <% 
        // Local date formatter for display like: "8 November 2025 08.00"
        function formatDateLocal(dateInput) {
          try {
            const d = new Date(dateInput);
            const months = [
              'Januari','Februari','Maret','April','Mei','Juni',
              'Juli','Agustus','September','Oktober','November','Desember'
            ];
            const day = d.getDate();
            const month = months[d.getMonth()];
            const year = d.getFullYear();
            const hours = String(d.getHours()).padStart(2, '0');
            const minutes = String(d.getMinutes()).padStart(2, '0');
            return `${day} ${month} ${year} ${hours}.${minutes}`;
          } catch (err) {
            return '';
          }
        }
      %>
      <div class="bg-white rounded-xl shadow-lg overflow-hidden">
        <div class="overflow-x-auto">
          <table class="w-full">
            <thead class="bg-gray-50">
              <tr>
                <th class="text-left py-4 px-6 text-gray-600 font-semibold">
                  No
                </th>
                <th class="text-left py-4 px-6 text-gray-600 font-semibold">
                  Kode Tamu
                </th>
                <th class="text-left py-4 px-6 text-gray-600 font-semibold">
                  Foto
                </th>
                <th class="text-left py-4 px-6 text-gray-600 font-semibold">
                  Nama Lengkap
                </th>
                <th class="text-left py-4 px-6 text-gray-600 font-semibold">
                  Asal Instansi
                </th>
                <th class="text-left py-4 px-6 text-gray-600 font-semibold">
                  Instansi Lain
                </th>
                <th class="text-left py-4 px-6 text-gray-600 font-semibold">
                  Nomor WhatsApp
                </th>
                <th class="text-left py-4 px-6 text-gray-600 font-semibold">
                  Waktu Check-in
                </th>
                <th class="text-center py-4 px-6 text-gray-600 font-semibold">
                  Aksi
                </th>
              </tr>
            </thead>
            <tbody>
              <% if (guests.length > 0) { %> <% guests.forEach((guest, index) =>
              { %>
              <tr class="border-b border-gray-100 hover:bg-gray-50">
                <td class="py-4 px-6"><%= startRecord + index %></td>
                <td class="py-4 px-6">
                  <% if (guest.kode) { %>
                  <span class="bg-gradient-to-r from-primary to-blue-500 text-white px-3 py-1.5 rounded-lg text-sm font-semibold shadow-md">
                    <%= guest.kode %>
                  </span>
                  <% } else { %>
                  <span class="text-gray-400 text-sm">-</span>
                  <% } %>
                </td>
                <td class="py-4 px-6">
                  <% if (guest.foto) { %>
                  <img
                    src="<%= guest.foto %>"
                    alt="Foto <%= guest.nama_lengkap %>"
                    class="w-16 h-16 object-cover rounded-lg cursor-pointer hover:opacity-80 transition shadow-md"
                    onclick="openModal(this.src, '<%= guest.nama_lengkap %>')"
                  />
                  <% } else { %>
                  <div
                    class="w-16 h-16 bg-gray-200 rounded-lg flex items-center justify-center"
                  >
                    <i class="fas fa-user text-gray-400 text-2xl"></i>
                  </div>
                  <% } %>
                </td>
                <td class="py-4 px-6 font-medium"><%= guest.nama_lengkap %></td>
                <td class="py-4 px-6">
                  <span
                    class="bg-blue-100 text-blue-800 px-3 py-1 rounded-full text-sm"
                  >
                    <%= guest.nama_sekolah %>
                  </span>
                </td>
                <td class="py-4 px-6">
                  <% if (guest.other_instansi) { %>
                  <span class="bg-purple-100 text-purple-800 px-3 py-1 rounded-full text-sm">
                    <%= guest.other_instansi %>
                  </span>
                  <% } else { %>
                  <span class="text-gray-400 text-sm">-</span>
                  <% } %>
                </td>
                <td class="py-4 px-6">
                  <a
                    href="https://wa.me/<%= guest.nomor_wa %>"
                    target="_blank"
                    class="text-green-600 hover:text-green-800"
                  >
                    <i class="fab fa-whatsapp mr-1"></i><%= guest.nomor_wa %>
                  </a>
                </td>
                <td class="py-4 px-6 text-gray-600 text-sm">
                  <%= formatDateLocal(guest.created_at) %>
                </td>
                <td class="py-4 px-6">
                  <div class="flex justify-center">
                    <button
                      data-id="<%= guest.id %>"
                      data-name="<%= guest.nama_lengkap %>"
                      onclick="confirmDelete(this.dataset.id, this.dataset.name)"
                      class="bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded-lg transition"
                    >
                      <i class="fas fa-trash"></i>
                    </button>
                  </div>
                </td>
              </tr>
              <% }); %> <% } else { %>
              <tr>
                <td colspan="8" class="py-8 text-center text-gray-500">
                  <i class="fas fa-inbox text-4xl mb-3"></i>
                  <p>Belum ada data tamu</p>
                </td>
              </tr>
              <% } %>
            </tbody>
          </table>
        </div>
      </div>

      <!-- Pagination -->
      <% if (totalPages > 1) { %>
      <div class="mt-6 flex flex-col sm:flex-row items-center justify-between gap-4">
        <!-- Info -->
        <div class="text-sm text-gray-600">
          Menampilkan <strong><%= startRecord %></strong> sampai <strong><%= endRecord %></strong> 
          dari <strong><%= totalRecords %></strong> data tamu
        </div>

        <!-- Pagination Controls -->
        <div class="flex items-center gap-2">
          <!-- Previous Button -->
          <% 
          function buildPageUrl(page) {
            let url = '?page=' + page;
            if (selectedSchool && selectedSchool !== 'all') {
              url += '&sekolah=' + encodeURIComponent(selectedSchool);
            }
            return url;
          }
          %>
          <% if (currentPageNumber > 1) { %>
            <a href="<%= buildPageUrl(currentPageNumber - 1) %>" 
               class="px-3 py-2 rounded-lg bg-white border border-gray-300 text-gray-600 hover:bg-gray-50 transition">
              <i class="fas fa-chevron-left"></i>
            </a>
          <% } else { %>
            <span class="px-3 py-2 rounded-lg bg-gray-100 border border-gray-200 text-gray-400 cursor-not-allowed">
              <i class="fas fa-chevron-left"></i>
            </span>
          <% } %>

          <!-- Page Numbers -->
          <div class="flex items-center gap-1">
            <% 
            let startPage = Math.max(1, currentPageNumber - 2);
            let endPage = Math.min(totalPages, currentPageNumber + 2);
            
            // Adjust if we're near the beginning or end
            if (currentPageNumber <= 3) {
              endPage = Math.min(totalPages, 5);
            }
            if (currentPageNumber > totalPages - 3) {
              startPage = Math.max(1, totalPages - 4);
            }
            %>

            <!-- First page if not in range -->
            <% if (startPage > 1) { %>
              <a href="<%= buildPageUrl(1) %>" 
                 class="px-3 py-2 rounded-lg bg-white border border-gray-300 text-gray-600 hover:bg-gray-50 transition">
                1
              </a>
              <% if (startPage > 2) { %>
                <span class="px-2 text-gray-400">...</span>
              <% } %>
            <% } %>

            <!-- Page range -->
            <% for (let i = startPage; i <= endPage; i++) { %>
              <% if (i === currentPageNumber) { %>
                <span class="px-3 py-2 rounded-lg bg-primary text-white font-semibold">
                  <%= i %>
                </span>
              <% } else { %>
                <a href="<%= buildPageUrl(i) %>" 
                   class="px-3 py-2 rounded-lg bg-white border border-gray-300 text-gray-600 hover:bg-gray-50 transition">
                  <%= i %>
                </a>
              <% } %>
            <% } %>

            <!-- Last page if not in range -->
            <% if (endPage < totalPages) { %>
              <% if (endPage < totalPages - 1) { %>
                <span class="px-2 text-gray-400">...</span>
              <% } %>
              <a href="<%= buildPageUrl(totalPages) %>" 
                 class="px-3 py-2 rounded-lg bg-white border border-gray-300 text-gray-600 hover:bg-gray-50 transition">
                <%= totalPages %>
              </a>
            <% } %>
          </div>

          <!-- Next Button -->
          <% if (currentPageNumber < totalPages) { %>
            <a href="<%= buildPageUrl(currentPageNumber + 1) %>" 
               class="px-3 py-2 rounded-lg bg-white border border-gray-300 text-gray-600 hover:bg-gray-50 transition">
              <i class="fas fa-chevron-right"></i>
            </a>
          <% } else { %>
            <span class="px-3 py-2 rounded-lg bg-gray-100 border border-gray-200 text-gray-400 cursor-not-allowed">
              <i class="fas fa-chevron-right"></i>
            </span>
          <% } %>
        </div>
      </div>
      <% } %>

      <!-- Summary -->
          <% if (totalRecords > 0) { %>
      <div class="mt-6 bg-gray-100 rounded-lg p-4">
        <p class="text-gray-700">
          <i class="fas fa-info-circle text-primary mr-2"></i>
          Total: <strong><%= totalRecords %></strong> tamu terdaftar
          <% if (totalPages > 1) { %>
                • Halaman <strong><%= currentPageNumber %></strong> dari <strong><%= totalPages %></strong>
          <% } %>
        </p>
      </div>
      <% } %>
    </div>

    <!-- Photo Modal -->
    <div id="photoModal" class="modal">
      <span class="close-modal" onclick="closeModal()">&times;</span>
      <img class="modal-content" id="modalImage" />
      <div
        style="
          text-align: center;
          color: white;
          font-size: 20px;
          margin-top: 20px;
        "
        id="modalCaption"
      ></div>
    </div>

    <!-- Progress Bar Overlay -->
    <div id="progressOverlay" class="progress-overlay">
      <div class="progress-container">
        <!-- Icon animasi -->
        <div id="progressIcon" class="progress-icon">
          <i class="fas fa-file-excel"></i>
        </div>

        <!-- Checkmark success -->
        <div id="checkmarkCircle" class="checkmark-circle">
          <svg class="checkmark" viewBox="0 0 52 52">
            <path
              class="checkmark-path"
              fill="none"
              d="M14 27l7 7 16-16"
            ></path>
          </svg>
        </div>

        <!-- Title -->
        <div id="progressTitle" class="progress-title">
          Menyiapkan Data Excel...
        </div>

        <!-- Subtitle -->
        <div id="progressSubtitle" class="progress-subtitle">
          Mohon tunggu sebentar
        </div>

        <!-- Progress Bar -->
        <div class="progress-bar-container">
          <div id="progressBar" class="progress-bar"></div>
        </div>

        <!-- Percentage -->
        <div id="progressPercentage" class="progress-percentage">0%</div>

        <!-- Status -->
        <div id="progressStatus" class="progress-status">
          Mengambil data dari database...
        </div>
      </div>
    </div>

    <!-- Delete Form (Hidden) -->
    <form id="deleteForm" method="POST" style="display: none"></form>

    <!-- Generate Kode Modal -->
    <div id="generateKodeModal" class="generate-modal">
      <div class="generate-modal-content">
        <!-- Header -->
        <div class="bg-gradient-to-r from-primary to-blue-600 p-6 text-white">
          <div class="flex items-center justify-between">
            <div>
              <h3 class="text-2xl font-bold flex items-center">
                <i class="fas fa-qrcode mr-3"></i>Generate Kode Tamu
              </h3>
              <p class="text-sm text-blue-100 mt-1">
                Pilih tamu yang ingin di-generate kodenya
              </p>
            </div>
            <button
              onclick="closeGenerateKodeModal()"
              class="text-white hover:text-gray-200 text-2xl transition"
            >
              <i class="fas fa-times"></i>
            </button>
          </div>
        </div>

        <!-- Loading State -->
        <div id="modalLoading" class="p-8 text-center">
          <div
            class="inline-block animate-spin rounded-full h-12 w-12 border-t-4 border-b-4 border-primary"
          ></div>
          <p class="mt-4 text-gray-600">Memuat data...</p>
        </div>

        <!-- Content -->
        <div id="modalContent" class="hidden">
          <!-- Actions -->
          <div class="p-6 bg-gray-50 border-b flex items-center justify-between gap-4">
            <div class="flex items-center gap-3">
              <input
                type="checkbox"
                id="selectAll"
                onchange="toggleSelectAll(this)"
                class="custom-checkbox"
              />
              <label for="selectAll" class="text-sm font-medium text-gray-700 cursor-pointer">
                Pilih Semua
              </label>
              <span id="selectedCount" class="text-sm text-gray-500">
                (0 dipilih)
              </span>
            </div>
            <div class="flex gap-2">
              <button
                onclick="generateSelectedKode()"
                class="bg-primary hover:bg-primary-dark text-white px-4 py-2 rounded-lg transition text-sm font-medium"
              >
                <i class="fas fa-check mr-2"></i>Generate Terpilih
              </button>
              <button
                onclick="autoGenerateAll()"
                class="bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded-lg transition text-sm font-medium"
              >
                <i class="fas fa-magic mr-2"></i>Auto Generate Semua
              </button>
            </div>
          </div>

          <!-- List Tamu -->
          <div class="generate-modal-body p-6">
            <div id="tamuList" class="space-y-3">
              <!-- Will be filled by JavaScript -->
            </div>
            <div id="emptyState" class="hidden text-center py-12">
              <div
                class="inline-flex items-center justify-center w-20 h-20 bg-green-100 rounded-full mb-4"
              >
                <i class="fas fa-check-circle text-green-500 text-4xl"></i>
              </div>
              <h4 class="text-lg font-semibold text-gray-800 mb-2">
                Semua Tamu Sudah Punya Kode!
              </h4>
              <p class="text-gray-600">
                Tidak ada tamu yang perlu di-generate kode
              </p>
            </div>
          </div>
        </div>
      </div>
    </div>

    <script>
      // Toggle Statistik Collapse
      function toggleStatistik() {
        const content = document.getElementById('statistikContent');
        const icon = document.getElementById('toggleIcon');
        
        if (content.style.maxHeight && content.style.maxHeight !== '0px') {
          // Collapse
          content.style.maxHeight = '0px';
          icon.style.transform = 'rotate(0deg)';
        } else {
          // Expand
          content.style.maxHeight = content.scrollHeight + 'px';
          icon.style.transform = 'rotate(180deg)';
        }
      }

      // Filter by School
      function filterBySchool(schoolId) {
        const currentUrl = new URL(window.location.href);
        if (schoolId === "all") {
          currentUrl.searchParams.delete("sekolah");
        } else {
          currentUrl.searchParams.set("sekolah", schoolId);
        }
        // Reset to page 1 when changing filter
        currentUrl.searchParams.delete("page");
        window.location.href = currentUrl.toString();
      }

      // ===== SHORTCUT DROPDOWN FUNCTIONALITY =====
      function toggleShortcutDropdown() {
        const dropdown = document.getElementById('shortcutDropdownMenu');
        const icon = document.getElementById('shortcutDropdownIcon');
        const isVisible = dropdown.classList.contains('opacity-100');
        
        if (isVisible) {
          closeShortcutDropdown();
        } else {
          openShortcutDropdown();
        }
      }

      function openShortcutDropdown() {
        const dropdown = document.getElementById('shortcutDropdownMenu');
        const icon = document.getElementById('shortcutDropdownIcon');
        
        dropdown.classList.remove('opacity-0', 'invisible', 'scale-95');
        dropdown.classList.add('opacity-100', 'visible', 'scale-100');
        icon.classList.add('rotate-180');
        
        // Close dropdown when clicking outside
        setTimeout(() => {
          document.addEventListener('click', handleOutsideClick);
        }, 100);
      }

      function closeShortcutDropdown() {
        const dropdown = document.getElementById('shortcutDropdownMenu');
        const icon = document.getElementById('shortcutDropdownIcon');
        
        dropdown.classList.remove('opacity-100', 'visible', 'scale-100');
        dropdown.classList.add('opacity-0', 'invisible', 'scale-95');
        icon.classList.remove('rotate-180');
        
        document.removeEventListener('click', handleOutsideClick);
      }

      function handleOutsideClick(event) {
        const dropdown = document.getElementById('shortcutDropdownMenu');
        const button = document.getElementById('shortcutDropdownBtn');
        
        if (!dropdown.contains(event.target) && !button.contains(event.target)) {
          closeShortcutDropdown();
        }
      }

      // Close dropdown with Escape key
      document.addEventListener('keydown', function(event) {
        if (event.key === 'Escape') {
          closeShortcutDropdown();
        }
      });

      function confirmDelete(id, nama) {
        Swal.fire({
          title: 'Hapus Data Tamu?',
          html: `Apakah Anda yakin ingin menghapus data tamu <strong>"${nama}"</strong>?`,
          icon: 'warning',
          showCancelButton: true,
          confirmButtonColor: '#ef4444',
          cancelButtonColor: '#6b7280',
          confirmButtonText: '<i class="fas fa-trash mr-2"></i>Ya, Hapus!',
          cancelButtonText: '<i class="fas fa-times mr-2"></i>Batal',
          reverseButtons: true,
          customClass: {
            confirmButton: 'px-6 py-3 rounded-lg font-semibold',
            cancelButton: 'px-6 py-3 rounded-lg font-semibold'
          }
        }).then((result) => {
          if (result.isConfirmed) {
            const form = document.getElementById("deleteForm");
            form.action = `/admin/data-tamu/delete/${id}`;
            form.submit();
          }
        });
      }

      // Copy Public Link Function
      function handleCopyPublicLink() {
        // Get current hostname and port
        const protocol = window.location.protocol; // http: or https:
        const hostname = window.location.hostname; // localhost or domain
        const port = window.location.port; // 1000 or empty
        
        // Build the public link
        let publicLink;
        if (port && port !== '80' && port !== '443') {
          publicLink = `${protocol}//${hostname}:${port}/buku-tamu`;
        } else {
          publicLink = `${protocol}//${hostname}/buku-tamu`;
        }

        // Copy to clipboard using modern API
        if (navigator.clipboard && window.isSecureContext) {
          navigator.clipboard.writeText(publicLink).then(() => {
            showCopySuccessMessage(publicLink);
          }).catch(err => {
            console.error('Failed to copy using clipboard API:', err);
            fallbackCopyToClipboard(publicLink);
          });
        } else {
          // Fallback for older browsers or non-secure contexts
          fallbackCopyToClipboard(publicLink);
        }
      }

      // Fallback copy method for older browsers
      function fallbackCopyToClipboard(text) {
        const textArea = document.createElement('textarea');
        textArea.value = text;
        textArea.style.position = 'fixed';
        textArea.style.left = '-999999px';
        textArea.style.top = '-999999px';
        document.body.appendChild(textArea);
        textArea.focus();
        textArea.select();
        
        try {
          const successful = document.execCommand('copy');
          if (successful) {
            showCopySuccessMessage(text);
          } else {
            showCopyErrorMessage();
          }
        } catch (err) {
          console.error('Fallback copy failed:', err);
          showCopyErrorMessage();
        }
        
        document.body.removeChild(textArea);
      }

      // Show success message with copied link
      function showCopySuccessMessage(link) {
        Swal.fire({
          icon: 'success',
          title: 'Link Berhasil Disalin!',
          html: `
            <div class="text-left">
              <p class="mb-3 text-gray-700">Link form buku tamu telah disalin ke clipboard:</p>
              <div class="bg-gray-100 border border-gray-300 rounded-lg p-3 mb-3">
                <code class="text-primary font-mono text-sm break-all">${link}</code>
              </div>
              <div class="text-sm text-gray-600">
                <i class="fas fa-info-circle text-blue-500 mr-2"></i>
                Bagikan link ini kepada tamu untuk mengisi buku tamu digital.
              </div>
            </div>
          `,
          confirmButtonColor: '#6184D6',
          confirmButtonText: '<i class="fas fa-check mr-2"></i>OK',
          width: '500px',
          customClass: {
            confirmButton: 'px-6 py-3 rounded-lg font-semibold'
          }
        });
      }

      // Show error message if copy failed
      function showCopyErrorMessage() {
        const protocol = window.location.protocol;
        const hostname = window.location.hostname;
        const port = window.location.port;
        
        let publicLink;
        if (port && port !== '80' && port !== '443') {
          publicLink = `${protocol}//${hostname}:${port}/buku-tamu`;
        } else {
          publicLink = `${protocol}//${hostname}/buku-tamu`;
        }

        Swal.fire({
          icon: 'error',
          title: 'Gagal Menyalin Link',
          html: `
            <div class="text-left">
              <p class="mb-3 text-gray-700">Tidak dapat menyalin otomatis. Silakan copy manual link berikut:</p>
              <div class="bg-gray-100 border border-gray-300 rounded-lg p-3 mb-3">
                <input 
                  type="text" 
                  value="${publicLink}" 
                  readonly 
                  class="w-full text-primary font-mono text-sm bg-transparent border-none outline-none"
                  onclick="this.select()"
                />
              </div>
              <div class="text-sm text-gray-600">
                <i class="fas fa-mouse-pointer text-orange-500 mr-2"></i>
                Klik pada text box untuk memilih, lalu tekan Ctrl+C (Windows) atau Cmd+C (Mac).
              </div>
            </div>
          `,
          confirmButtonColor: '#ef4444',
          confirmButtonText: '<i class="fas fa-check mr-2"></i>Mengerti',
          width: '500px',
          customClass: {
            confirmButton: 'px-6 py-3 rounded-lg font-semibold'
          }
        });
      }

      // Export Excel with Progress Bar
      function handleExportExcel() {
        const overlay = document.getElementById("progressOverlay");
        const progressBar = document.getElementById("progressBar");
        const progressPercentage =
          document.getElementById("progressPercentage");
        const progressTitle = document.getElementById("progressTitle");
        const progressSubtitle = document.getElementById("progressSubtitle");
        const progressStatus = document.getElementById("progressStatus");
        const progressIcon = document.getElementById("progressIcon");
        const checkmarkCircle = document.getElementById("checkmarkCircle");

        // Show overlay
        overlay.style.display = "flex";

        // Reset states
        progressBar.style.width = "0%";
        progressPercentage.textContent = "0%";
        progressIcon.style.display = "block";
        checkmarkCircle.style.display = "none";

        // Simulate progress stages
        let progress = 0;

        // Stage 1: Mengambil data (0-30%)
        const stage1 = setInterval(() => {
          progress += 2;
          if (progress <= 30) {
            progressBar.style.width = progress + "%";
            progressPercentage.textContent = progress + "%";
            progressStatus.textContent = "Mengambil data dari database...";
          } else {
            clearInterval(stage1);
            // Stage 2: Memproses data (30-60%)
            const stage2 = setInterval(() => {
              progress += 2;
              if (progress <= 60) {
                progressBar.style.width = progress + "%";
                progressPercentage.textContent = progress + "%";
                progressStatus.textContent =
                  "Memproses data ke format Excel...";
              } else {
                clearInterval(stage2);
                // Stage 3: Membuat file (60-90%)
                const stage3 = setInterval(() => {
                  progress += 2;
                  if (progress <= 90) {
                    progressBar.style.width = progress + "%";
                    progressPercentage.textContent = progress + "%";
                    progressStatus.textContent = "Membuat file Excel...";
                  } else {
                    clearInterval(stage3);
                  }
                }, 30);
              }
            }, 30);
          }
        }, 30);

        // Get current filter value
        const schoolFilter = document.getElementById('schoolFilter');
        const selectedSchool = schoolFilter ? schoolFilter.value : 'all';
        
        // Build export URL with filter parameters
        let exportUrl = "/admin/data-tamu/export";
        if (selectedSchool && selectedSchool !== 'all') {
          exportUrl += `?sekolah=${encodeURIComponent(selectedSchool)}`;
        }

        // Start actual download
        let responseHeaders = null;
        
        fetch(exportUrl)
          .then((response) => {
            responseHeaders = response; // Store response for later access to headers
            if (!response.ok) {
              throw new Error("Export failed");
            }
            return response.blob();
          })
          .then((blob) => {
            // Complete progress
            progress = 100;
            progressBar.style.width = "100%";
            progressPercentage.textContent = "100%";
            progressStatus.textContent = "Download selesai!";

            // Show success state
            setTimeout(() => {
              progressIcon.style.display = "none";
              checkmarkCircle.style.display = "block";
              progressTitle.textContent = "Berhasil!";
              progressSubtitle.textContent = "File Excel berhasil diunduh";
              progressStatus.textContent = "Silakan cek folder Downloads Anda";
            }, 300);

            // Download file
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement("a");
            a.href = url;
            
            // Try to get filename from response headers, fallback to default
            let filename = `Data_Tamu_${new Date()
              .toISOString()
              .slice(0, 19)
              .replace(/[:.]/g, "-")}.xlsx`;
              
            if (responseHeaders) {
              const contentDisposition = responseHeaders.headers.get('Content-Disposition');
              if (contentDisposition) {
                const filenameMatch = contentDisposition.match(/filename[^;=\n]*=((['"]).*?\2|[^;\n]*)/);
                if (filenameMatch && filenameMatch[1]) {
                  filename = filenameMatch[1].replace(/['"]/g, '');
                }
              }
            }
            
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            window.URL.revokeObjectURL(url);
            document.body.removeChild(a);

            // Close overlay after 2 seconds
            setTimeout(() => {
              overlay.style.display = "none";
            }, 2000);
          })
          .catch((error) => {
            console.error("Export error:", error);
            // Show error state
            progressBar.style.width = "100%";
            progressBar.style.background =
              "linear-gradient(90deg, #ef4444, #dc2626)";
            progressPercentage.textContent = "Error";
            progressPercentage.style.color = "#ef4444";
            progressTitle.textContent = "Gagal!";
            progressSubtitle.textContent = "Terjadi kesalahan saat export";
            progressStatus.textContent = "Silakan coba lagi";
            progressIcon.innerHTML =
              '<i class="fas fa-exclamation-triangle"></i>';
            progressIcon.style.color = "#ef4444";

            // Close overlay after 3 seconds
            setTimeout(() => {
              overlay.style.display = "none";
            }, 3000);
          });
      }

      // ===== MIGRATE PHOTOS FUNCTIONALITY =====
      function handleMigratePhotos() {
        <% if (!hasBase64Photos) { %>
        // Show message if no Base64 photos to migrate
        Swal.fire({
          icon: 'info',
          title: 'Tidak Ada Data',
          text: 'Semua foto sudah dalam format file. Tidak perlu migrate foto.',
          confirmButtonColor: '#6184D6',
          confirmButtonText: '<i class="fas fa-check mr-2"></i>OK',
          customClass: {
            confirmButton: 'px-6 py-3 rounded-lg font-semibold'
          }
        });
        return;
        <% } %>

        Swal.fire({
          title: 'Migrate Foto Base64?',
          html: `
            <div class="text-left">
              <p class="mb-3">Proses ini akan:</p>
              <ul class="list-disc list-inside text-sm space-y-2 text-gray-700">
                <li>Mengkonversi semua foto Base64 menjadi file gambar</li>
                <li>Menyimpan file ke direktori <code class="bg-gray-100 px-2 py-1 rounded">public/uploads/</code></li>
                <li>Update database dengan path file baru</li>
              </ul>
              <p class="mt-4 text-sm text-orange-600">
                <i class="fas fa-exclamation-triangle mr-2"></i>
                <strong>Catatan:</strong> Proses ini hanya perlu dilakukan sekali untuk data lama yang masih menggunakan Base64.
              </p>
            </div>
          `,
          icon: 'question',
          showCancelButton: true,
          confirmButtonColor: '#9333ea',
          cancelButtonColor: '#6b7280',
          confirmButtonText: '<i class="fas fa-sync-alt mr-2"></i>Ya, Migrate!',
          cancelButtonText: '<i class="fas fa-times mr-2"></i>Batal',
          reverseButtons: true,
          width: '600px',
          customClass: {
            confirmButton: 'px-6 py-3 rounded-lg font-semibold',
            cancelButton: 'px-6 py-3 rounded-lg font-semibold'
          }
        }).then((result) => {
          if (result.isConfirmed) {
            // Show loading
            Swal.fire({
              title: 'Memproses...',
              html: 'Sedang migrate foto, mohon tunggu...',
              allowOutsideClick: false,
              allowEscapeKey: false,
              didOpen: () => {
                Swal.showLoading();
              }
            });

            // Call migration API
            fetch('/admin/migrate-photos', {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json'
              }
            })
            .then(response => response.json())
            .then(data => {
              if (data.success) {
                Swal.fire({
                  title: 'Berhasil!',
                  html: `
                    <div class="text-left">
                      <p class="mb-3">${data.message}</p>
                      <div class="bg-gray-50 p-4 rounded-lg space-y-2 text-sm">
                        <div class="flex justify-between">
                          <span class="font-semibold">Total Data:</span>
                          <span class="text-blue-600 font-bold">${data.total}</span>
                        </div>
                        <div class="flex justify-between">
                          <span class="font-semibold text-green-600">Berhasil Migrate:</span>
                          <span class="text-green-600 font-bold">${data.migrated}</span>
                        </div>
                        ${data.failed > 0 ? `
                        <div class="flex justify-between">
                          <span class="font-semibold text-red-600">Gagal:</span>
                          <span class="text-red-600 font-bold">${data.failed}</span>
                        </div>
                        ` : ''}
                      </div>
                      ${data.failed > 0 ? `
                      <p class="mt-3 text-xs text-gray-500">
                        ID yang gagal: ${data.failedIds.join(', ')}
                      </p>
                      ` : ''}
                    </div>
                  `,
                  icon: 'success',
                  confirmButtonColor: '#22c55e',
                  confirmButtonText: 'OK',
                  width: '600px'
                }).then(() => {
                  // Reload page to show updated data
                  window.location.reload();
                });
              } else {
                Swal.fire({
                  title: 'Error!',
                  text: data.message || 'Terjadi kesalahan saat migrate foto',
                  icon: 'error',
                  confirmButtonColor: '#ef4444'
                });
              }
            })
            .catch(error => {
              console.error('Migration error:', error);
              Swal.fire({
                title: 'Error!',
                text: 'Terjadi kesalahan saat migrate foto',
                icon: 'error',
                confirmButtonColor: '#ef4444'
              });
            });
          }
        });
      }

      // Modal Functions
      function openModal(src, caption) {
        const modal = document.getElementById("photoModal");
        const modalImg = document.getElementById("modalImage");
        const modalCaption = document.getElementById("modalCaption");

        modal.style.display = "flex";
        modal.style.alignItems = "center";
        modal.style.justifyContent = "center";
        modalImg.src = src;
        modalCaption.innerHTML = caption;

        // Close modal when clicking outside the image
        modal.onclick = function (event) {
          if (event.target === modal) {
            closeModal();
          }
        };
      }

      function closeModal() {
        const modal = document.getElementById("photoModal");
        modal.style.display = "none";
      }

      // Close modal with Escape key
      document.addEventListener("keydown", function (event) {
        if (event.key === "Escape") {
          closeModal();
          closeGenerateKodeModal();
        }
      });

      // ===== GENERATE KODE FUNCTIONALITY =====
      let tamuWithoutKode = [];

      // Open Generate Kode Modal
      async function openGenerateKodeModal() {
        <% if (!hasDataWithoutKode) { %>
        // Show message if no data without kode
        Swal.fire({
          icon: 'info',
          title: 'Tidak Ada Data',
          text: 'Semua tamu sudah memiliki kode. Tidak perlu generate kode lagi.',
          confirmButtonColor: '#6184D6',
          confirmButtonText: '<i class="fas fa-check mr-2"></i>OK',
          customClass: {
            confirmButton: 'px-6 py-3 rounded-lg font-semibold'
          }
        });
        return;
        <% } %>

        const modal = document.getElementById("generateKodeModal");
        const loading = document.getElementById("modalLoading");
        const content = document.getElementById("modalContent");

        modal.classList.add("active");
        loading.style.display = "block";
        content.classList.add("hidden");

        try {
          const response = await fetch("/admin/api/tamu-without-kode");
          const result = await response.json();

          if (result.success) {
            tamuWithoutKode = result.data;
            displayTamuList(result.data);
            loading.style.display = "none";
            content.classList.remove("hidden");
          }
        } catch (error) {
          console.error("Error loading tamu:", error);
          Swal.fire({
            icon: 'error',
            title: 'Gagal Memuat Data',
            text: 'Tidak dapat memuat data tamu. Silakan coba lagi.',
            confirmButtonColor: '#6184D6',
            confirmButtonText: '<i class="fas fa-check mr-2"></i>OK',
            customClass: {
              confirmButton: 'px-6 py-3 rounded-lg font-semibold',
              container: 'swal-on-modal'
            },
            heightAuto: false
          });
          closeGenerateKodeModal();
        }
      }

      // Close Generate Kode Modal
      function closeGenerateKodeModal() {
        const modal = document.getElementById("generateKodeModal");
        modal.classList.remove("active");
        tamuWithoutKode = [];
      }

      // Display Tamu List
      function displayTamuList(data) {
        const container = document.getElementById("tamuList");
        const emptyState = document.getElementById("emptyState");

        if (data.length === 0) {
          container.innerHTML = "";
          emptyState.classList.remove("hidden");
          document.getElementById("selectAll").disabled = true;
          return;
        }

        emptyState.classList.add("hidden");
        container.innerHTML = data
          .map(
            (tamu, index) => `
          <div class="bg-white border border-gray-200 rounded-lg p-4 hover:border-primary transition">
            <div class="flex items-center gap-4">
              <input
                type="checkbox"
                id="tamu_${tamu.id}"
                value="${tamu.id}"
                onchange="updateSelectedCount()"
                class="custom-checkbox"
              />
              <label for="tamu_${tamu.id}" class="flex-1 cursor-pointer">
                <div class="flex items-center justify-between">
                  <div class="flex-1">
                    <p class="font-semibold text-gray-800">${tamu.nama_lengkap}</p>
                    <div class="flex items-center gap-3 mt-1">
                      <span class="text-sm text-gray-500">
                        <i class="fas fa-school mr-1"></i>${tamu.nama_sekolah || "-"}
                      </span>
                      ${tamu.other_instansi ? `
                      <span class="text-sm text-purple-600">
                        <i class="fas fa-building mr-1"></i>${tamu.other_instansi}
                      </span>
                      ` : ''}
                      <span class="text-xs text-gray-400">
                        <i class="far fa-clock mr-1"></i>${new Date(
                          tamu.created_at
                        ).toLocaleString("id-ID", {
                          day: "numeric",
                          month: "short",
                          hour: "2-digit",
                          minute: "2-digit",
                        })}
                      </span>
                    </div>
                  </div>
                  <div class="bg-yellow-100 text-yellow-800 px-3 py-1 rounded-full text-xs font-medium">
                    <i class="fas fa-exclamation-circle mr-1"></i>Belum ada kode
                  </div>
                </div>
              </label>
            </div>
          </div>
        `
          )
          .join("");
      }

      // Toggle Select All
      function toggleSelectAll(checkbox) {
        const checkboxes = document.querySelectorAll('#tamuList input[type="checkbox"]');
        checkboxes.forEach((cb) => {
          cb.checked = checkbox.checked;
        });
        updateSelectedCount();
      }

      // Update Selected Count
      function updateSelectedCount() {
        const checkboxes = document.querySelectorAll(
          '#tamuList input[type="checkbox"]:checked'
        );
        const count = checkboxes.length;
        document.getElementById("selectedCount").textContent = `(${count} dipilih)`;

        // Update select all checkbox
        const allCheckboxes = document.querySelectorAll('#tamuList input[type="checkbox"]');
        const selectAllCheckbox = document.getElementById("selectAll");
        selectAllCheckbox.checked = count === allCheckboxes.length && count > 0;
      }

      // Generate Selected Kode
      async function generateSelectedKode() {
        const checkboxes = document.querySelectorAll(
          '#tamuList input[type="checkbox"]:checked'
        );
        const selectedIds = Array.from(checkboxes).map((cb) => parseInt(cb.value));

        if (selectedIds.length === 0) {
          Swal.fire({
            icon: 'warning',
            title: 'Pilih Tamu',
            text: 'Silakan pilih minimal 1 tamu untuk di-generate kode!',
            confirmButtonColor: '#6184D6',
            confirmButtonText: '<i class="fas fa-check mr-2"></i>OK',
            customClass: {
              confirmButton: 'px-6 py-3 rounded-lg font-semibold',
              container: 'swal-on-modal'
            },
            heightAuto: false
          });
          return;
        }

        const result = await Swal.fire({
          title: 'Generate Kode Terpilih?',
          html: `Generate kode untuk <strong>${selectedIds.length} tamu</strong> yang dipilih?`,
          icon: 'question',
          showCancelButton: true,
          confirmButtonColor: '#6184D6',
          cancelButtonColor: '#6b7280',
          confirmButtonText: '<i class="fas fa-check mr-2"></i>Ya, Generate!',
          cancelButtonText: '<i class="fas fa-times mr-2"></i>Batal',
          reverseButtons: true,
          customClass: {
            confirmButton: 'px-6 py-3 rounded-lg font-semibold',
            cancelButton: 'px-6 py-3 rounded-lg font-semibold',
            container: 'swal-on-modal'
          },
          heightAuto: false
        });

        if (!result.isConfirmed) {
          return;
        }

        // Show loading
        Swal.fire({
          title: 'Memproses...',
          html: 'Sedang generate kode, mohon tunggu...',
          allowOutsideClick: false,
          allowEscapeKey: false,
          customClass: {
            container: 'swal-on-modal'
          },
          heightAuto: false,
          didOpen: () => {
            Swal.showLoading();
          }
        });

        try {
          const response = await fetch("/admin/api/generate-kode", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({
              tamuIds: selectedIds,
              autoGenerate: false,
            }),
          });

          const result = await response.json();

          if (result.success) {
            await Swal.fire({
              icon: 'success',
              title: 'Berhasil!',
              text: result.message,
              confirmButtonColor: '#22c55e',
              confirmButtonText: '<i class="fas fa-check mr-2"></i>OK',
              customClass: {
                confirmButton: 'px-6 py-3 rounded-lg font-semibold',
                container: 'swal-on-modal'
              },
              heightAuto: false
            });
            closeGenerateKodeModal();
            window.location.reload();
          } else {
            Swal.fire({
              icon: 'error',
              title: 'Gagal!',
              text: result.message || "Gagal generate kode",
              confirmButtonColor: '#ef4444',
              confirmButtonText: '<i class="fas fa-times mr-2"></i>OK',
              customClass: {
                confirmButton: 'px-6 py-3 rounded-lg font-semibold',
                container: 'swal-on-modal'
              },
              heightAuto: false
            });
          }
        } catch (error) {
          console.error("Error generate kode:", error);
          Swal.fire({
            icon: 'error',
            title: 'Terjadi Kesalahan',
            text: 'Terjadi kesalahan saat generate kode. Silakan coba lagi.',
            confirmButtonColor: '#ef4444',
            confirmButtonText: '<i class="fas fa-times mr-2"></i>OK',
            customClass: {
              confirmButton: 'px-6 py-3 rounded-lg font-semibold',
              container: 'swal-on-modal'
            },
            heightAuto: false
          });
        }
      }

      // Auto Generate All
      async function autoGenerateAll() {
        if (tamuWithoutKode.length === 0) {
          Swal.fire({
            icon: 'info',
            title: 'Tidak Ada Data',
            text: 'Tidak ada tamu yang perlu di-generate kode.',
            confirmButtonColor: '#6184D6',
            confirmButtonText: '<i class="fas fa-check mr-2"></i>OK',
            customClass: {
              confirmButton: 'px-6 py-3 rounded-lg font-semibold',
              container: 'swal-on-modal'
            },
            heightAuto: false
          });
          return;
        }

        const result = await Swal.fire({
          title: 'Auto Generate Semua?',
          html: `Auto generate kode untuk <strong>${tamuWithoutKode.length} tamu</strong> sekaligus?`,
          icon: 'question',
          showCancelButton: true,
          confirmButtonColor: '#22c55e',
          cancelButtonColor: '#6b7280',
          confirmButtonText: '<i class="fas fa-magic mr-2"></i>Ya, Generate Semua!',
          cancelButtonText: '<i class="fas fa-times mr-2"></i>Batal',
          reverseButtons: true,
          customClass: {
            confirmButton: 'px-6 py-3 rounded-lg font-semibold',
            cancelButton: 'px-6 py-3 rounded-lg font-semibold',
            container: 'swal-on-modal'
          },
          heightAuto: false
        });

        if (!result.isConfirmed) {
          return;
        }

        // Show loading
        Swal.fire({
          title: 'Memproses...',
          html: 'Sedang auto generate kode, mohon tunggu...',
          allowOutsideClick: false,
          allowEscapeKey: false,
          customClass: {
            container: 'swal-on-modal'
          },
          heightAuto: false,
          didOpen: () => {
            Swal.showLoading();
          }
        });

        try {
          const response = await fetch("/admin/api/generate-kode", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({
              autoGenerate: true,
            }),
          });

          const result = await response.json();

          if (result.success) {
            await Swal.fire({
              icon: 'success',
              title: 'Berhasil!',
              text: result.message,
              confirmButtonColor: '#22c55e',
              confirmButtonText: '<i class="fas fa-check mr-2"></i>OK',
              customClass: {
                confirmButton: 'px-6 py-3 rounded-lg font-semibold',
                container: 'swal-on-modal'
              },
              heightAuto: false
            });
            closeGenerateKodeModal();
            window.location.reload();
          } else {
            Swal.fire({
              icon: 'error',
              title: 'Gagal!',
              text: result.message || "Gagal auto generate kode",
              confirmButtonColor: '#ef4444',
              confirmButtonText: '<i class="fas fa-times mr-2"></i>OK',
              customClass: {
                confirmButton: 'px-6 py-3 rounded-lg font-semibold',
                container: 'swal-on-modal'
              },
              heightAuto: false
            });
          }
        } catch (error) {
          console.error("Error auto generate kode:", error);
          Swal.fire({
            icon: 'error',
            title: 'Terjadi Kesalahan',
            text: 'Terjadi kesalahan saat auto generate kode. Silakan coba lagi.',
            confirmButtonColor: '#ef4444',
            confirmButtonText: '<i class="fas fa-times mr-2"></i>OK',
            customClass: {
              confirmButton: 'px-6 py-3 rounded-lg font-semibold',
              container: 'swal-on-modal'
            },
            heightAuto: false
          });
        }
      }
    </script>
  </body>
</html>
